name: Node.js CI

on:
  push:
    branches: '*'
    paths-ignore:
      - '*.md'
      - 'wiki/**'
  pull_request:
    branches: '*'
    paths-ignore:
      - '*.md'
      - 'wiki/**'

env:
  BUILTIN_PYTHON_VERSION: 3.12.10

jobs:
  shared_python:
    runs-on: ${{ matrix.platform }}

    strategy:
      fail-fast: false
      matrix:
        platform: [macos-14]
        node-version: [18.x, 20.x, 22.x, 24.x]
        python-version: ["3.11", "3.12", "3.13"]

    steps:
      - uses: actions/checkout@v5
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - run: npm install --ignore-scripts
      - run: npx @mapbox/node-pre-gyp configure
        if: runner.os != 'macOS'
      - run: npx @mapbox/node-pre-gyp configure --debug
        if: runner.os == 'macOS'
      - run: npx @mapbox/node-pre-gyp build -j max
      - run: python3 -m pip install --upgrade pip
      - run: pip3 install -r test/requirements.txt
      - run: npx tsc --noEmit
      - run: npx mocha --repeats 20
        env:
          PYMPORT_DEBUG_INIT: 1
          PYMPORT_DEBUG_ASYNC: 1

 